name: 内核构建

on:
  workflow_dispatch:
    inputs:
      GKI_DEV:
        description: 'GKI 分支，例如 android14-6.1-2024-10 或 android14-6.1'
        required: true
        default: 'android14-6.1-2024-10'
      KSU_BRANCH:
        description: '使用 SukiSU Ultra/KernelSU Next? (y/n)'
        required: true
        default: 'y'
      APPLY_SSG:
        description: '启用 SSG IO 调度? (y/n)'
        required: true
        default: 'y'
      APPLY_BBR:
        description: '启用 BBR 拥塞控制? (y/n/d)'
        required: true
        default: 'd'
      APPLY_KPM:
        description: '启用 KPM ? (y/n)'
        required: true
        default: 'y'
      APPLY_BBG:
        description: '启用 BBG 基带保护 ? (y/n)'
        required: true
        default: 'y'

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: 检查储存库
        uses: actions/checkout@v4

      - name: 定义环境变量
        run: |
          mkdir -p local
          BUILD_ENV="local/build.env"
          GKI_DEV="${{ github.event.inputs.GKI_DEV }}"

          # 提取前两段生成 GKI_VERSION
          GKI_VERSION="gki-$(echo $GKI_DEV | cut -d'-' -f1-2)"

          cat > $BUILD_ENV <<EOF
          GKI_DEV=${GKI_DEV}
          GKI_VERSION=${GKI_VERSION}
          KSU_BRANCH=${{ github.event.inputs.KSU_BRANCH }}
          APPLY_SSG=${{ github.event.inputs.APPLY_SSG }}
          APPLY_BBR=${{ github.event.inputs.APPLY_BBR }}
          APPLY_KPM=${{ github.event.inputs.APPLY_KPM }}
          APPLY_BBG=${{ github.event.inputs.APPLY_BBG }}
          EOF

          echo ">>> build.env 内容:"
          cat $BUILD_ENV

      - name: 执行build.sh
        run: |
          chmod +x local/build.sh
          ./local/build.sh

      - name: 上传AnyKernel3刷机包
        uses: actions/upload-artifact@v4
        with:
         name: kernel-zip
         path: out/kernel.zip
